[toc]

## plugins(kong/openresty/nginx 的精魂所在)

1. Kong 开源版本提供 8 个类型 共 28 个插件

   - **身份认证类**: 只有认证后才能使用 consumer 概念
   - 安全防护类
   - **流量控制类**
   - 云平台插件类
   - 分析监控类
   - 转换请求类型类
   - **日志记录类**
   - 其他插件类

2. 常见的插件应用

   - Ip restriction: 黑白名单

     1. 可以配置一个区段, 也可以是特定的 IP 地址
     2. 可以针对所有的消费方, 也可以是特定的某个消费方
     3. 可以针对所有的 API, 也可以针对特定的 API 接口
     4. 黑白名单能同时配置并生效(docker 内可能会是 172.22.0.1)

   - Oauth2: 需要 api 本身就是 https 且设置 only_https=true

     1. Authorization code: 授权码模式
     2. Implicit Grant: 隐式模式
     3. Resource Owner Password Credentials: 密码模式
     4. Client Credentials: 客户端模式

   - **Jwt**
   - Rate limiting: 限流请求
   - request termination

     1. 使用指定的状态代码和消息终止传入请求
     2. 允许暂时阻止 API 或 Consumer, 但不能触发阈值自动熔断: 实际意义不大
     3. 可用于发版部署的时候率先熔断服务

   - File-log

     1. 将请求和响应数据附加到磁盘上的日志文件
     2. 指定路径为文件全路径不是目录路径

   - http-log: 将请求和响应日志发送到 HTTP 服务器
   - Prometheus: 监控, 公开与 Kong 和代理上游服务相关的指标
   - Canary: 灰度发布

## 插件-权限认证

### basic auth

1. 简介: 用户名密码方式进行认证, 将其按照 `admin:123456` 方式进行 Base64 后放入请求头

   ![avatar](/static/image/kong/kong-plugin-au-ba.png)

2. 示例: `Authorization: Basic YWRtaW46MTIzNDU2`

   ```shell
   curl -i -X GET --url http://localhost:8000/request/
     –header 'Host: example.com' \
     –header 'Authorization: Basic YWRtaW46MTIzNDU2'
   ```

3. pros: 简单且被广泛支持
4. cons

   - Base64 **不安全**, 在网络上裸奔的
   - 请求被恶意用户重放攻击
   - 中间人攻击

5. 使用场景: 很少使用

   - 内部网络(无安全约束网络)
   - 结合 https 使用

6. 性能: `性能下降约为11%`

### key auth: 与 ba 类似

1. 简介: 将指定密钥放入请求头/参数
2. 示例

   ```shell
   $ curl -i -X GET \
     --url http://localhost:8000/auth \
     --header "Host: example.com" \
     --header "apikey: toutiao"
   ```

3. 使用场景: 使用不多

   - 内部网络(无安全约束网络)
   - 面向开发人员, 作为调用第三方凭证

4. 性能: `性能下降约为11%`

### hmac auth

1. 简介: 一种用于给消息**签名**的技术, 防止消息在传递的过程中被人修改

   - Hash-based Message Authentication Code
   - 需要设置 ak/sk 用于签名的计算
   - 客户端调用接口时, 根据参数和 ak 进行自然排序后并使用 sk 进行签名生成一个额外的参数 digest
   - 服务器根据预先设置的 sk 进行同样的摘要计算, 并要求结果完全一致
   - 注意 sk 不能在网络中传输, 以及在不受信任的位置存放

   ![avatar](/static/image/kong/kong-plugin-au-ba.png)

2. 示例: `Authorization: Basic YWRtaW46MTIzNDU2`

   ```shell
   curl -i -X GET --url http://localhost:8000/request/
     –header 'Host: example.com' \
     –header 'Authorization: Basic YWRtaW46MTIzNDU2'
   ```

3. pros: 安全, 可以**防止重放攻击** + 时间戳
4. cons

   - Base64 **不安全**, 在网络上裸奔的
   - 请求被恶意用户重放攻击
   - 中间人攻击

5. 使用场景(使用一般): 没有统一的标准, 各家实现不一致
6. 性能: `性能下降约为20%`

### jwt auth

1. [intros](https://github.com/Alice52/security-tutorial/blob/master/awesome/jwt-token.md): auth repo
2. pros: 无状态-单点登录 | 自校验 | 标准化 | 体积小
3. cons

   - 有长度限制且默认明文传输
   - 不能撤销

4. 使用场景(主流): 分布式
5. 性能: `性能下降约为22%`

### oauth2 auth

1. [intros](https://github.com/Alice52/security-tutorial/blob/master/awesome/oauth.md): auth repo

---

## reference

1. https://docs.konghq.com/hub/
